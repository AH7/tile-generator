#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders
RUN_DIR=/var/vcap/sys/run/{{package.name}}
LOG_DIR=/var/vcap/sys/log/{{package.name}}
PACKAGES_DIR=/var/vcap/packages/{{package.name}}

PIDFILE=$RUN_DIR/{{package.name}}.pid

source /var/vcap/packages/common/utils.sh

case $1 in

  start)
    pid_guard $PIDFILE {{package.name}}

    mkdir -p $RUN_DIR
    mkdir -p $LOG_DIR

    chown vcap:vcap $RUN_DIR
    chown -R vcap:vcap $LOG_DIR

    echo $$ > $PIDFILE
    chown vcap:vcap $PIDFILE

    for image in $PACKAGES_DIR/*.tgz; do
      /var/vcap/packages/docker/bin/docker \
        --host unix:///var/vcap/sys/run/docker/docker.sock \
        load -i $image \
        >>$LOG_DIR/{{package.name}}.stdout.log \
        2>>$LOG_DIR/{{package.name}}.stderr.log
    done

    # do nothing forever
    exec tail -f /dev/null
    ;;

  stop)
    kill_and_wait $PIDFILE

    ;;
  *)
    echo "Usage: {{package.name}}_ctl {start|stop}"

    ;;

esac
exit 0
