#! /bin/bash
set -e -x


  <%
    def grab_app_domain_name
      app_domains_str = properties.app_domains.to_s
      array_start = ( app_domains_str =~ /^\[/ )
      if (array_start == 0)
        app_domain_entry = app_domains_str.gsub(/^\[/, '').gsub(/\]/,'').gsub(/,.*/, '')
      else
        app_domain_entry = app_domains_str
      end
      app_domain_entry
    end
    app_domain = grab_app_domain_name
  %>

export SCHEME=https
export PATH="/var/vcap/packages/cf_cli/bin:$PATH"
export ADMIN_USER=<%= properties.cf.admin_user %>
export ADMIN_PASSWORD=<%= properties.cf.admin_password %>
export DOMAIN=<%= properties.domain %>
export API_ENDPOINT=$SCHEME://api.$DOMAIN
export APP_DOMAIN=<%="#{app_domain}"%>
export APP_NAME=<%= properties.{{ package.name }}.app_name %>
export APP_VERSION=<%= properties.{{ package.name }}.app_version %>
export APP_URI=<%= properties.{{ package.name }}.app_uri %>
export PERSISTENCE_STORE_TYPE=<%= properties.{{ package.name }}.persistence_store_type %>
export BIND_TO_SERVICE=<%= properties.{{ package.name }}.bind_to_service %>

export ORG=<%= properties.{{ package.name }}.app_push.org %>
export SPACE=<%= properties.{{ package.name }}.app_push.space %>

function authenticate() {
  cf api $API_ENDPOINT <% if properties.ssl.skip_cert_verify %>--skip-ssl-validation<% end %>
  cf auth $ADMIN_USER $ADMIN_PASSWORD
}

function target() {
  if [ "$ORG" == "" ]; then
    export ORG=${APP_NAME}-org
    export QUOTA=${APP_NAME}-quota
  fi
  
  cf target -o $ORG

  if [ "$SPACE" == "" ]; then
    export SPACE=${APP_NAME}-space
  fi
  
  cf target -s $SPACE
}

function unbind_services() {
  for service in `cf services | grep ${APP_NAME}-${APP_VERSION} | grep "." | awk '{ print $1 }' `
  do
    if [ "$service" != "" ]; then
      cf unbind-service ${APP_NAME}-${APP_VERSION} $service

      # Iff the service name matches the app name, delete the service as we created it
      if [[ "$service" == "${APP_NAME}-${APP_VERSION}"* ]]; then
        cf delete-service -f $service
      fi
    fi
  done
}

cf -v
authenticate
target

unbind_services
cf delete -f ${APP_NAME}-${APP_VERSION}

apps=`CF_TRACE=false cf a | grep "No apps found"`
if [ "$apps" == "No apps found" -a "$ORG"  == "${APP_NAME}"*-org ]; then
  cf delete-space -f $SPACE
  cf delete-org -f $ORG
fi
