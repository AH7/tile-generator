#!/bin/bash

set -e

export CF=`which cf`

function cf() {
	if [ "$1" == "--output" ]; then
		shift
		echo cf "$@"
		$CF "$@"
		result=$?
	else
		echo cf "$@"
		output=`$CF "$@" 2>&1`
		result=$?
		if [ "$result" -ne "0" ]; then
			echo "$output"
		fi
	fi
	return $result
}

function import_opsmgr_variables() {
	export SCHEME=https
	export ADMIN_USER=<%= properties.cf.admin_user %>
	export ADMIN_PASSWORD=<%= properties.cf.admin_password %>
	export DOMAIN=<%= properties.domain %>
	export APP_DOMAIN=<%= properties.app_domains[0] %>
	export CF_ORG=<%= properties.org %>
	export CF_ORG_QUOTA=<%= properties.org_quota %>
	export CF_SPACE=<%= properties.space %>
	export CF_TARGET=$SCHEME://api.${DOMAIN}
	export CF_SKIP_SSL=<%= properties.ssl.skip_cert_verify %>
	export SECURITY_USER_NAME=<%= properties.security.user %>
	export SECURITY_USER_PASSWORD=<%= properties.security.password %>
	{% if context.dynamic_service_plans is defined %}
	<%
	  plans = { }
	  if properties.dynamic_service_plans

	      p("dynamic_service_plans").each do |plan|
	        plan_name = plan['name']
	        plans[plan_name] = plan
	      end
	  end
	%>
	export DYNAMIC_PLANS='<%= JSON.dump(plans) %>'
	{% endif %}
	{% for property in context.all_properties %}
	export {{ property.name | upper }}="<%= properties.{{ property.name }} %>"
	{% endfor %}
}

function prepare_cf_cli {
	export PATH="/var/vcap/packages/cf_cli/bin:$PATH"
	export CF_HOME=`pwd`/home/cf
	mkdir -p $CF_HOME
}

function authenticate() {
	cf --output --version
	if [ "$CF_SKIP_SSL" == "true" -o "$CF_SKIP_SSL" == "True" ]; then
		cf api $CF_TARGET --skip-ssl-validation
	else
		cf api $CF_TARGET
	fi
	cf auth $ADMIN_USER $ADMIN_PASSWORD
}

function setup_target_org() {
	if [ -z "$CF_ORG" ]; then
		CF_ORG={{ context.name }}-org
	fi
	if ! cf org $CF_ORG >/dev/null; then
		cf create-org $CF_ORG
	fi
	cf target -o $CF_ORG
}

function setup_org_quota() {
	if [ -n "$CF_ORG_QUOTA" ]; then
		export CF_QUOTA=${CF_ORG}-quota
		if ! cf quota $CF_QUOTA >/dev/null; then
			cf create-quota $CF_QUOTA -m ${CF_ORG_QUOTA}m -r 10 -s 10
		fi
		cf update-quota $CF_QUOTA -m ${CF_ORG_QUOTA}m -r 10 -s 10 --disallow-paid-service-plans
		cf set-quota $CF_ORG $CF_QUOTA
	fi
}

function setup_target_space() {
	if [ -z "$CF_SPACE" ]; then
		CF_SPACE={{ context.name }}-space
	fi
	if ! cf space $CF_SPACE >/dev/null; then
		cf create-space $CF_SPACE
	fi
	cf target -s $CF_SPACE
}

function setup_package_path() {
	if [ -z "$PACKAGE_PATH" ]; then
		export PACKAGE_PATH=/var/vcap/packages
	fi
}

function apply_open_security_group() {
	if ! cf security-group all_open >/dev/null; then
		cf create-security-group all_open $PACKAGE_PATH/templates/all_open.json
	fi
	cf bind-running-security-group all_open
}

function add_env_vars() {
	cf set-env $1 UAA_HOST "$SCHEME://uaa.$DOMAIN"
	cf set-env $1 CC_HOST "$CF_TARGET"
	cf set-env $1 LOGIN_HOST "$SCHEME://login.$DOMAIN"
	cf set-env $1 ROOT "\$HOME"
	cf set-env $1 SCHEME "$SCHEME"
	cf set-env $1 VERIFY_SSL "$CF_SKIP_SSL"

	# Adding additional properties that most spring based apps or internal apps seem to be expecting
	cf set-env $1 CF_ORG "$CF_ORG"
	cf set-env $1 CF_SPACE "$CF_SPACE"
	cf set-env $1 CF_TARGET "$CF_TARGET"
	cf set-env $1 SECURITY_USER_NAME "$SECURITY_USER_NAME"
	cf set-env $1 SECURITY_USER_PASSWORD "$SECURITY_USER_PASSWORD"

	# Dynamic plans (if defined)
	{% if context.dynamic_service_plans is defined %}
	cf set-env $1 PLANS "$DYNAMIC_PLANS"
	{% endif %}

	# Custom variables from tile.yml
	{% for property in context.all_properties %}
	cf set-env $1 {{ property.name | upper }} "${{ property.name | upper }}"
	{% endfor %}
}

function add_cf_credentials() {
	cf set-env $1 CF_ADMIN_USER "$ADMIN_USER"
	cf set-env $1 CF_ADMIN_USERNAME "$ADMIN_USER"
	cf set-env $1 CF_ADMIN_PASSWORD "$ADMIN_PASSWORD"
}

function delete_older_versions() {
	PKG_NAME="$1"
	APP_NAME="$2"
	cf --output apps | grep "$PKG_NAME" | grep -v "$APP_NAME" | while read app rest; do
		cf delete -f $app
	done
}

function wait_till_running() {
	for i in `seq 1  6`; do
		matches=`CF_TRACE=true $CF app "$1" | grep RUNNING | grep "$1"`
		if [ "$?" -ne "0" ]; then
			sleep 10
			echo "cf app $1   # waiting for running state"
		else
			break
		fi
	done
}

function deploy_app() {
	PKG_NAME="$1"
	APP_NAME="$2"
	APP_HOST="$3"
	DOCKER_IMAGE="$4"
	NEEDS_CF_CREDS="$5"
	AUTO_SERVICES="$6"
	cf --output push ${APP_NAME} -n ${APP_HOST} -d ${APP_DOMAIN} \
		${DOCKER_IMAGE} -f $PACKAGE_PATH/${PKG_NAME}/manifest.yml \
		--no-start
	add_env_vars ${APP_NAME}
	if [ -n "$NEEDS_CF_CREDS" ]; then
		add_cf_credentials ${APP_NAME}
	fi
	provision_auto_services ${AUTO_SERVICES}
	cf --output restart ${APP_NAME}
	wait_till_running ${APP_NAME}
	delete_older_versions ${PKG_NAME} ${APP_NAME}
}

function provision_auto_services() {
	for service in $*; do
		plan=`cf --output marketplace | grep $service | awk '{ print $2 }' | sed 's/,//g'`
		if [ "$plan" != "" ]; then
			cf create-service $service $plan ${APP_NAME}-${APP_VERSION}-$service
			cf bind-service ${APP_NAME}-${APP_VERSION} ${APP_NAME}-${APP_VERSION}-$service
		else
			echo "no service matching" $service "in marketplace"
			exit 1
		fi
	done
}

import_opsmgr_variables
prepare_cf_cli
authenticate
setup_target_org
setup_org_quota
setup_target_space
setup_package_path
{% if context.apply_open_security_group %}
apply_open_security_group
{% endif %}

{% for package in context.packages %}
# Deploy package {{ package.name }}
#

{% if package.is_app %}
export PKG_NAME={{ package.name }}
export APP_NAME={{ package.name }}-{{ context.version }}
export APP_HOST={{ (package.manifest and package.manifest.host) or package.name }}
export DOCKER_IMAGE="{{ ( package.is_docker and '--docker-image ' + package.image ) or '' }}"
export NEEDS_CF_CREDS="{{ ( package.needs_cf_credentials and 'true' ) or 'false' }}"
export AUTO_SERVICES="<%= properties.{{ package.name }}.auto_services %>"
export AUTO_SERVICES="${AUTO_SERVICES} <%= properties.{{ package.name }}.persistence_store_type %>"
deploy_app "$PKG_NAME" "$APP_NAME" "$APP_HOST" "$DOCKER_IMAGE" "$NEEDS_CF_CREDS" "$AUTO_SERVICES"
{% endif %}

{% if package.is_broker %}
{% endif %}

{% if package.is_buildpack %}
{% endif %}

{% endfor %}
